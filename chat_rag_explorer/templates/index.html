<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Chat RAG Explorer</title>
        <link rel="stylesheet" href="/static/style.css" />
    </head>
    <body>
        <!-- Skip link for keyboard navigation -->
        <a href="#chat-history" class="skip-link">Skip to chat</a>

        <div class="main-layout">
            <main class="app-container" role="main">
                <header>
                    <div class="header-content">
                        <button id="sidebar-toggle" class="sidebar-toggle icon-btn" aria-label="Toggle sidebar" aria-expanded="false" aria-controls="sidebar">
                            <span class="hamburger-icon" aria-hidden="true">&#9776;</span>
                        </button>
                        <h1>Chat RAG Explorer</h1>
                        <div class="header-actions">
                            <button id="clear-chat-btn" class="icon-btn" title="Clear chat" aria-label="Clear chat history">&#8635;</button>
                            <a href="/settings" class="icon-btn" title="Settings" aria-label="Open settings">&#9881;</a>
                        </div>
                    </div>
                </header>

                <!-- API Key Warning Banner -->
                <div id="api-key-banner" class="api-key-banner" style="display: none;">
                    <div class="banner-content">
                        <div class="banner-icon">&#9888;</div>
                        <div class="banner-text">
                            <strong>API Key Required</strong>
                            <p>The app cannot send messages without an OpenRouter API key.</p>
                            <ul>
                                <li>Get a key at <a href="https://openrouter.ai/keys" target="_blank" rel="noopener">openrouter.ai/keys</a></li>
                                <li>Taking a course? Your instructor will provide a key.</li>
                                <li>See README for installation instructions.</li>
                            </ul>
                        </div>
                        <button id="banner-dismiss" class="banner-dismiss" title="Dismiss">&times;</button>
                    </div>
                </div>

                <div id="chat-history" class="chat-history" role="log" aria-live="polite" aria-label="Chat messages">
                    <!-- Messages will appear here -->
                </div>

                <div class="input-area">
                    <form id="chat-form" role="search">
                        <label for="message-input" class="visually-hidden">Message input</label>
                        <input
                            type="text"
                            id="message-input"
                            placeholder="Type your message..."
                            autocomplete="off"
                            aria-label="Type your message"
                        />
                        <button type="submit" aria-label="Send message">Send</button>
                    </form>
                </div>
            </main>

            <!-- Mobile sidebar overlay -->
            <div id="sidebar-overlay" class="sidebar-overlay" aria-hidden="true"></div>

            <aside id="sidebar" class="sidebar" role="complementary" aria-label="Chat settings and metrics">
                <div class="sidebar-section">
                    <div class="metric">
                        <span class="label">Model:</span>
                        <a href="/settings#model" id="metric-model" class="value value-link">-</a>
                    </div>
                    <div class="metric">
                        <span class="label">Prompt:</span>
                        <a href="/settings#prompt" id="metric-prompt" class="value value-link">-</a>
                    </div>
                </div>
                <div class="sidebar-section">
                    <h3>Last Interaction</h3>
                    <div class="metric">
                        <span class="label">
                            <span class="tooltip-wrapper">
                                <button type="button" class="help-icon" aria-label="What are prompt tokens?" tabindex="0">?</button>
                                <span class="tooltip-content" role="tooltip">Input tokens sent to the LLM - includes your message and the full conversation history visible in the chat.</span>
                            </span>
                            Prompt Tokens:
                        </span>
                        <span id="metric-prompt-tokens" class="value">0</span>
                    </div>
                    <div class="metric">
                        <span class="label">
                            <span class="tooltip-wrapper">
                                <button type="button" class="help-icon" aria-label="What are completion tokens?" tabindex="0">?</button>
                                <span class="tooltip-content" role="tooltip">Output tokens generated by the LLM for this response.</span>
                            </span>
                            Completion Tokens:
                        </span>
                        <span id="metric-completion-tokens" class="value">0</span>
                    </div>
                    <div class="metric">
                        <span class="label">
                            <span class="tooltip-wrapper">
                                <button type="button" class="help-icon" aria-label="What is total tokens?" tabindex="0">?</button>
                                <span class="tooltip-content" role="tooltip">Sum of prompt + completion tokens for this interaction.</span>
                            </span>
                            Total Tokens:
                        </span>
                        <span id="metric-total-tokens" class="value">0</span>
                    </div>
                </div>
                <div class="sidebar-section">
                    <h3>Session Totals</h3>
                    <div class="metric">
                        <span class="label">
                            <span class="tooltip-wrapper">
                                <button type="button" class="help-icon" aria-label="What is total prompt tokens?" tabindex="0">?</button>
                                <span class="tooltip-content" role="tooltip">Cumulative input tokens across all interactions this session.</span>
                            </span>
                            Total Prompt:
                        </span>
                        <span id="total-prompt-tokens" class="value">0</span>
                    </div>
                    <div class="metric">
                        <span class="label">
                            <span class="tooltip-wrapper">
                                <button type="button" class="help-icon" aria-label="What is total completion tokens?" tabindex="0">?</button>
                                <span class="tooltip-content" role="tooltip">Cumulative output tokens across all interactions this session.</span>
                            </span>
                            Total Completion:
                        </span>
                        <span id="total-completion-tokens" class="value">0</span>
                    </div>
                    <div class="metric">
                        <span class="label">
                            <span class="tooltip-wrapper">
                                <button type="button" class="help-icon" aria-label="What is session total tokens?" tabindex="0">?</button>
                                <span class="tooltip-content" role="tooltip">Grand total of all tokens used this session.</span>
                            </span>
                            Total Tokens:
                        </span>
                        <span id="total-total-tokens" class="value">0</span>
                    </div>
                </div>
                <div class="sidebar-section">
                    <h3>Parameters</h3>
                    <div class="param-control" id="temperature-control">
                        <div class="param-header">
                            <label for="temperature-slider">
                                <span class="tooltip-wrapper">
                                    <button type="button" class="help-icon" aria-label="What is temperature?" tabindex="0">?</button>
                                    <span class="tooltip-content" role="tooltip">Controls randomness. Lower = focused. Higher = creative. <a href="https://openrouter.ai/docs/api/reference/parameters#temperature" target="_blank" rel="noopener">Learn more</a></span>
                                </span>
                                Temperature
                            </label>
                            <span id="temperature-value" class="param-value" aria-live="polite">1.0</span>
                        </div>
                        <input type="range" id="temperature-slider" min="0" max="2" step="0.1" value="1.0" aria-describedby="temperature-hint">
                        <span class="param-hint" id="temperature-hint"></span>
                    </div>
                    <div class="param-control" id="top-p-control">
                        <div class="param-header">
                            <label for="top-p-slider">
                                <span class="tooltip-wrapper">
                                    <button type="button" class="help-icon" aria-label="What is Top P?" tabindex="0">?</button>
                                    <span class="tooltip-content" role="tooltip">Nucleus sampling. 0.1 = top 10% tokens. Alter this OR temperature, not both. <a href="https://openrouter.ai/docs/api/reference/parameters#top-p" target="_blank" rel="noopener">Learn more</a></span>
                                </span>
                                Top P
                            </label>
                            <span id="top-p-value" class="param-value" aria-live="polite">1.0</span>
                        </div>
                        <input type="range" id="top-p-slider" min="0" max="1" step="0.05" value="1.0" aria-describedby="top-p-hint">
                        <span class="param-hint" id="top-p-hint"></span>
                    </div>
                </div>
                <div class="sidebar-section">
                    <h3><a href="/settings#rag" class="section-link">RAG</a></h3>
                    <div class="rag-toggle-container">
                        <label class="rag-toggle">
                            <input type="checkbox" id="rag-enabled-toggle" disabled>
                            <span class="toggle-label">Enable RAG</span>
                        </label>
                        <a href="/settings#rag" id="rag-status" class="rag-status not-configured">
                            Not configured
                        </a>
                    </div>
                </div>
            </aside>
        </div>

        <!-- Details Modal -->
        <div id="details-modal" class="modal-overlay" role="dialog" aria-modal="true" aria-labelledby="details-modal-title" aria-hidden="true">
            <div class="modal details-modal">
                <div class="details-modal-header">
                    <h3 id="details-modal-title">What the LLM Received</h3>
                    <div class="modal-header-buttons">
                        <button id="details-modal-maximize" class="modal-maximize-btn" title="Maximize" aria-label="Maximize dialog">
                            <span class="maximize-icon" aria-hidden="true">&#x26F6;</span>
                            <span class="restore-icon" aria-hidden="true">&#x2750;</span>
                        </button>
                        <button id="details-modal-close" class="modal-close-btn" aria-label="Close dialog">&times;</button>
                    </div>
                </div>
                <div class="details-modal-body">
                    <div id="details-content"></div>
                </div>
            </div>
        </div>

        <!-- Error Modal -->
        <div id="error-modal" class="modal-overlay" role="alertdialog" aria-modal="true" aria-labelledby="error-modal-title" aria-describedby="error-message" aria-hidden="true">
            <div class="modal error-modal">
                <div class="error-modal-header">
                    <h3 id="error-modal-title">Error</h3>
                    <button id="error-modal-close" class="modal-close-btn" aria-label="Close error dialog">&times;</button>
                </div>
                <div class="error-modal-body">
                    <div id="error-message"></div>
                    <div id="error-details-container" class="error-details-section">
                        <h4>Details</h4>
                        <pre id="error-details"></pre>
                    </div>
                </div>
            </div>
        </div>

        <script src="/static/marked.min.js"></script>

        <script src="/static/purify.min.js"></script>
        <script src="/static/script.js"></script>
    </body>
</html>
